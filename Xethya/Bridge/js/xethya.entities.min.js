(function(){"use strict";Bridge.define("Xethya.Entities.AttributeExtensions",{statics:{byName:function(obj,name){return Bridge.Linq.Enumerable.from(obj).single(function(a){return Bridge.referenceEquals(a.getName(),name)})},rollAllValues:function(obj){for(var attribute,$t=Bridge.getEnumerator(obj);$t.moveNext();)attribute=$t.getCurrent(),attribute.setValue(Bridge.Decimal(new Xethya.DiceRolling.Dice(attribute.getUpperBound()).roll()))}}});Bridge.define("Xethya.Entities.EntityAlignment",{statics:{getLawfulGood:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Good,Xethya.Entities.Order.Lawful)},getLawfulNeutral:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Neutral,Xethya.Entities.Order.Lawful)},getLawfulEvil:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Evil,Xethya.Entities.Order.Lawful)},getNeutralGood:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Good,Xethya.Entities.Order.Neutral)},getNeutral:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Neutral,Xethya.Entities.Order.Neutral)},getNeutralEvil:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Evil,Xethya.Entities.Order.Neutral)},getChaoticGood:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Good,Xethya.Entities.Order.Chaotic)},getChaoticNeutral:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Neutral,Xethya.Entities.Order.Chaotic)},getChaoticEvil:function(){return new Xethya.Entities.EntityAlignment(Xethya.Entities.Moral.Evil,Xethya.Entities.Order.Chaotic)}},config:{properties:{Moral:0,Order:0}},constructor:function(moral,order){this.setMoral(moral);this.setOrder(order)}});Bridge.define("Xethya.Entities.EntityContainer",{statics:{config:{properties:{_Container:null}},initializeIfNeeded:function(){Xethya.Entities.EntityContainer.get_Container()==null&&Xethya.Entities.EntityContainer.set_Container(new Bridge.Dictionary$2(Bridge.Guid,Xethya.Entities.Entity)())},register:function(entity){if(entity.getIsVolatile())throw new Bridge.ArgumentException("The entity must be non-volatile in order to be registered in the Container. Set IsVolatile to true in order to do so");Xethya.Entities.EntityContainer.get_Container().add(entity.getID(),entity)},lookup:function(guid){return Xethya.Entities.EntityContainer.get_Container().get(Bridge.Guid.parse(guid))},__GetContainer:function(){return Bridge.global.__XETHYA_DEBUG__?Xethya.Entities.EntityContainer.get_Container():null}}});Bridge.define("Xethya.Entities.Modifier",{config:{properties:{ID:null,Value:Bridge.Decimal(0),Source:null,Active:!1}},constructor:function(){this.setID(Bridge.Guid.newGuid().toString());this.setActive(!0)},constructor$1:function(id){this.setID(id);this.setActive(!0)},activate:function(){this.setActive(!0)},deactivate:function(){this.setActive(!1)}});Bridge.define("Xethya.Entities.Moral",{statics:{Good:0,Neutral:1,Evil:2},$enum:!0});Bridge.define("Xethya.Entities.Order",{statics:{Lawful:0,Neutral:1,Chaotic:2},$enum:!0});Bridge.define("Xethya.Entities.SkillExtensions",{statics:{byName:function(obj,name){return Bridge.Linq.Enumerable.from(obj).single(function(s){return Bridge.referenceEquals(s.getName(),name)})}}});Bridge.define("Xethya.Entities.StatExtensions",{statics:{byName:function(obj,name){return Bridge.Linq.Enumerable.from(obj).single(function(s){return Bridge.referenceEquals(s.getName(),name)})}}});Bridge.define("Xethya.Entities.Attribute",{inherits:[Xethya.Common.ValueInterval,Xethya.Common.Interfaces.INameable,Xethya.Common.Interfaces.IWithModifiers],_Value:Bridge.Decimal(0),config:{properties:{ID:null,Name:null,Modifiers:null}},constructor:function(name){Xethya.Common.ValueInterval.prototype.$constructor.call(this,0,2147483647);this.setID(Bridge.Guid.newGuid().toString());this.setName(name);this.setModifiers(new Bridge.List$1(Xethya.Entities.Modifier)())},constructor$1:function(name,valueRange){Xethya.Common.ValueInterval.prototype.$constructor.call(this,valueRange.getLowerBound(),valueRange.getUpperBound());this.setID(Bridge.Guid.newGuid().toString());this.setName(name);this.setModifiers(new Bridge.List$1(Xethya.Entities.Modifier)())},getModifierSum:function(){return Bridge.Linq.Enumerable.from(this.getModifiers()).sum($_.Xethya.Entities.Attribute.f1)},getBaseModifier:function(){return Bridge.Linq.Enumerable.from(this.getModifiers()).first().getValue()},getValue:function(){return this._Value},setValue:function(value){if(this.valueInRange(value))this._Value=value,this._RefreshBaseModifier();else throw new Bridge.ArgumentOutOfRangeException("Value","Attribute "+this.getName()+" has a value out of range "+Xethya.Common.ValueInterval.prototype.toString.call(this));},getComputedValue:function(){return this.getValue().add(this.getModifierSum())},_RefreshBaseModifier:function(){var baseModifier=new Xethya.Entities.Modifier("constructor$1","baseModifier");baseModifier.setSource(null);baseModifier.setValue(Bridge.Decimal(Bridge.Convert.toInt32(this.getValue().mul(Bridge.Decimal(.15)))));this.getModifiers().getCount()===0?this.getModifiers().add(baseModifier):this.getModifiers().setItem(0,baseModifier)},toString:function(){var sign=this.getModifierSum().gte(Bridge.Decimal(0))?"+":"-";return Bridge.Int.format(this.getValue(),"G")+" ("+sign+Bridge.Int.format(this.getModifierSum(),"G")+")"}});var $_={};Bridge.ns("Xethya.Entities.Attribute",$_);Bridge.apply($_.Xethya.Entities.Attribute,{f1:function(m){return m.getValue()}});Bridge.define("Xethya.Entities.Entity",{inherits:[Xethya.Common.Interfaces.INameable,Xethya.Common.Interfaces.IWithAttributes],config:{properties:{ID:null,Name:null,IsVolatile:!1,Attributes:null,IsAlive:!1},init:function(){this.ID=new Bridge.Guid}},constructor:function(){this.setID(Bridge.Guid.newGuid());this.setIsVolatile(!1);this.setIsAlive(!1);this.setAttributes(new Bridge.List$1(Xethya.Entities.Attribute)());this._RegisterInContainerIfNeeded()},constructor$1:function(name){this.setID(Bridge.Guid.newGuid());this.setName(name);this.setIsVolatile(!1);this.setIsAlive(!1);this.setAttributes(new Bridge.List$1(Xethya.Entities.Attribute)());this._RegisterInContainerIfNeeded()},_RegisterInContainerIfNeeded:function(){this.getIsVolatile()||(Xethya.Entities.EntityContainer.initializeIfNeeded(),Xethya.Entities.EntityContainer.register(this))},getAttributeByName:function(attributeName){return Bridge.Linq.Enumerable.from(this.getAttributes()).single(function(a){return Bridge.referenceEquals(a.getName(),attributeName)})}});Bridge.define("Xethya.Entities.EntityRace",{inherits:[Xethya.Common.Interfaces.INameable,Xethya.Common.Interfaces.IWithAttributes,Xethya.Common.Interfaces.IWithSkills,Xethya.Common.Interfaces.IWithStats],config:{properties:{LifeExpectancy:0,DefaultAlignment:null,Name:null,Attributes:null,Skills:null,Stats:null}},constructor:function(name){this.setName(name);this.setAttributes(new Bridge.List$1(Xethya.Entities.Attribute)());this.setSkills(new Bridge.List$1(Xethya.Entities.Skill)());this.setStats(new Bridge.List$1(Xethya.Entities.Stat)())},getAttributeByName:function(attributeName){return Xethya.Entities.AttributeExtensions.byName(this.getAttributes(),attributeName)},getSkillByName:function(skillName){return Xethya.Entities.SkillExtensions.byName(this.getSkills(),skillName)},getStatByName:function(statName){return Xethya.Entities.StatExtensions.byName(this.getStats(),statName)},defineAttributeBoost:function(attributeName,value){var attribute=new Xethya.Entities.Attribute("constructor",attributeName);attribute.setValue(Bridge.Decimal(value));this.getAttributes().add(attribute)},defineStatBoost:function(statName,value){var stat=new Xethya.Entities.Stat("constructor",statName),modifier=new Xethya.Entities.Modifier("constructor");modifier.setValue(Bridge.Decimal(value));stat.getModifiers().insert(1,modifier);this.getStats().add(stat)}});Bridge.define("Xethya.Entities.SkilledEntity",{inherits:[Xethya.Entities.Entity,Xethya.Common.Interfaces.IWithSkills,Xethya.Common.Interfaces.ICanUseSkills],config:{properties:{Skills:null}},constructor:function(){Xethya.Entities.Entity.prototype.$constructor.call(this);this.setSkills(new Bridge.List$1(Xethya.Entities.Skill)())},constructor$1:function(name){Xethya.Entities.Entity.prototype.constructor$1.call(this,name);this.setSkills(new Bridge.List$1(Xethya.Entities.Skill)())},getSkillByName:function(skillName){return Bridge.Linq.Enumerable.from(this.getSkills()).first(function(s){return Bridge.referenceEquals(s.getName(),skillName)})},useSkill:function(skillName){return this.getSkillByName(skillName).use()}});Bridge.define("Xethya.Entities.Skill",{inherits:[Xethya.Entities.Attribute,Xethya.Common.Interfaces.IWithAttributes,Xethya.Common.Interfaces.IModifierSource],config:{properties:{Attributes:null}},constructor:function(name){Xethya.Entities.Attribute.prototype.$constructor.call(this,name);this.setAttributes(new Bridge.List$1(Xethya.Entities.Attribute)())},constructor$1:function(name,valueRange){Xethya.Entities.Attribute.prototype.constructor$1.call(this,name,valueRange);this.setAttributes(new Bridge.List$1(Xethya.Entities.Attribute)())},getAttributeByName:function(attributeName){return Bridge.Linq.Enumerable.from(this.getAttributes()).first(function(a){return Bridge.referenceEquals(a.getName(),attributeName)})},use:function(){for(var st=new Xethya.DiceRolling.SkillThrow(this),str=st.roll$2(),attribute,$t=Bridge.getEnumerator(this.getAttributes());$t.moveNext();)attribute=$t.getCurrent(),str.setSkillAttributeModifiersValue(str.getSkillAttributeModifiersValue().add(attribute.getModifierSum()));return str.getThrowType()===Xethya.DiceRolling.DiceThrowType.Failure?str.setFailureRoll(new Xethya.DiceRolling.ChanceThrow("constructor").roll$1()):str.setFailureRoll(null),str}});Bridge.define("Xethya.Entities.Stat",{inherits:[Xethya.Entities.Attribute,Xethya.Common.Interfaces.IWithAttributes,Xethya.Common.Interfaces.IModifierSource,Xethya.Common.Interfaces.IWithStats],config:{properties:{Stats:null,CalculationCallback:null,Attributes:null}},constructor:function(name){Xethya.Entities.Attribute.prototype.$constructor.call(this,name);this.setStats(new Bridge.List$1(Xethya.Entities.Stat)());this.setAttributes(new Bridge.List$1(Xethya.Entities.Attribute)())},constructor$1:function(name,calculationCallback){Xethya.Entities.Attribute.prototype.$constructor.call(this,name);this.setStats(new Bridge.List$1(Xethya.Entities.Stat)());this.setAttributes(new Bridge.List$1(Xethya.Entities.Attribute)());this.setCalculationCallback(calculationCallback)},getValue:function(){if(this.getCalculationCallback()==null)throw new Bridge.InvalidOperationException("A calculation callback must be defined for the "+this.getName()+" stat.");return this.getCalculationCallback().call(null,this.getAttributes(),this.getStats())},getStatByName:function(statName){return Bridge.Linq.Enumerable.from(this.getStats()).single(function(s){return Bridge.referenceEquals(s.getName(),statName)})},_RefreshBaseModifier:function(){},getAttributeByName:function(attributeName){return Bridge.Linq.Enumerable.from(this.getAttributes()).first(function(a){return Bridge.referenceEquals(a.getName(),attributeName)})}});Bridge.define("Xethya.Entities.LivingEntity",{inherits:[Xethya.Entities.SkilledEntity,Xethya.Common.Interfaces.IWithStats],config:{properties:{Age:0,Height:0,Stats:null,Race:null}},constructor:function(race){Xethya.Entities.SkilledEntity.prototype.$constructor.call(this);this.setIsAlive(!0);this.setStats(new Bridge.List$1(Xethya.Entities.Stat)());this.setRace(race);this._RegisterLivingEntityAttributes();this._RegisterLivingEntitySkills();this._RegisterLivingEntityStats();this._ApplyRacialTraits()},getHasDeityTraits:function(){return Bridge.Linq.Enumerable.from(this.getAttributes()).any($_.Xethya.Entities.LivingEntity.f1)},getIsPureDeity:function(){return Bridge.Linq.Enumerable.from(this.getAttributes()).all($_.Xethya.Entities.LivingEntity.f1)},getIsBeyondLifeExpectancy:function(){return!new Xethya.Common.ValueInterval(Bridge.Decimal(1),Bridge.Decimal(this.getRace().getLifeExpectancy())).valueInRange(Bridge.Decimal(this.getAge()))},getStatByName:function(statName){return Bridge.Linq.Enumerable.from(this.getStats()).single(function(s){return Bridge.referenceEquals(s.getName(),statName)})},_RegisterLivingEntityAttributes:function(){this.getAttributes().addRange([Xethya.Common.Gamebook.AttributeDefinitions.getStrength(),Xethya.Common.Gamebook.AttributeDefinitions.getDexterity(),Xethya.Common.Gamebook.AttributeDefinitions.getConstitution(),Xethya.Common.Gamebook.AttributeDefinitions.getIntelligence(),Xethya.Common.Gamebook.AttributeDefinitions.getWisdom(),Xethya.Common.Gamebook.AttributeDefinitions.getCharisma()])},_RegisterLivingEntitySkills:function(){var STR=this.getAttributeByName(Xethya.Common.Gamebook.AttributeNames.Strength),DEX=this.getAttributeByName(Xethya.Common.Gamebook.AttributeNames.Dexterity),INT=this.getAttributeByName(Xethya.Common.Gamebook.AttributeNames.Intelligence),WIS=this.getAttributeByName(Xethya.Common.Gamebook.AttributeNames.Wisdom),CHA=this.getAttributeByName(Xethya.Common.Gamebook.AttributeNames.Charisma);this.getSkills().addRange([Xethya.Common.Gamebook.SkillDefinitions.athletics(STR),Xethya.Common.Gamebook.SkillDefinitions.acrobatics(DEX),Xethya.Common.Gamebook.SkillDefinitions.sleightOfHand(DEX),Xethya.Common.Gamebook.SkillDefinitions.stealth(DEX),Xethya.Common.Gamebook.SkillDefinitions.arcana(INT),Xethya.Common.Gamebook.SkillDefinitions.history(INT),Xethya.Common.Gamebook.SkillDefinitions.investigation(INT),Xethya.Common.Gamebook.SkillDefinitions.nature(INT),Xethya.Common.Gamebook.SkillDefinitions.religion(INT),Xethya.Common.Gamebook.SkillDefinitions.animalHandling(WIS),Xethya.Common.Gamebook.SkillDefinitions.insight(WIS),Xethya.Common.Gamebook.SkillDefinitions.medicine(WIS),Xethya.Common.Gamebook.SkillDefinitions.perception(WIS),Xethya.Common.Gamebook.SkillDefinitions.survival(WIS),Xethya.Common.Gamebook.SkillDefinitions.deception(CHA),Xethya.Common.Gamebook.SkillDefinitions.intimidation(CHA),Xethya.Common.Gamebook.SkillDefinitions.performance(CHA),Xethya.Common.Gamebook.SkillDefinitions.persuasion(CHA)])},_RegisterLivingEntityStats:function(){this.getStats().addRange([Xethya.Common.Gamebook.StatDefinitions.carryingCapacity(this.getAttributeByName(Xethya.Common.Gamebook.AttributeNames.Strength)),Xethya.Common.Gamebook.StatDefinitions.hitPoints(this.getAttributeByName(Xethya.Common.Gamebook.AttributeNames.Constitution))]);this.getStats().addRange([Xethya.Common.Gamebook.StatDefinitions.objectHandlingCapacity(this.getStatByName(Xethya.Common.Gamebook.StatNames.CarryingCapacity))])},_ApplyRacialTraits:function(){for(var $t1,$t2,attribute,raceTrait,skill,raceTrait1,stat,raceTrait2,$t=Bridge.getEnumerator(this.getRace().getAttributes());$t.moveNext();)attribute=$t.getCurrent(),raceTrait=new Xethya.Entities.Modifier("constructor$1",attribute.getName()+"RaceTrait"),raceTrait.setValue(Bridge.Decimal(Bridge.Convert.toInt32(Xethya.Entities.AttributeExtensions.byName(this.getRace().getAttributes(),attribute.getName()).getValue()))),Xethya.Entities.AttributeExtensions.byName(this.getAttributes(),attribute.getName()).getModifiers().add(raceTrait);for($t1=Bridge.getEnumerator(this.getRace().getSkills());$t1.moveNext();)skill=$t1.getCurrent(),raceTrait1=new Xethya.Entities.Modifier("constructor$1",skill.getName()+"RaceTrait"),raceTrait1.setValue(Bridge.Decimal(Bridge.Convert.toInt32(Xethya.Entities.SkillExtensions.byName(this.getRace().getSkills(),skill.getName()).getValue()))),Xethya.Entities.SkillExtensions.byName(this.getSkills(),skill.getName()).getModifiers().add(raceTrait1);for($t2=Bridge.getEnumerator(this.getRace().getStats());$t2.moveNext();)stat=$t2.getCurrent(),raceTrait2=new Xethya.Entities.Modifier("constructor$1",stat.getName()+"RaceTrait"),raceTrait2.setValue(Bridge.Decimal(Bridge.Convert.toInt32(Xethya.Entities.StatExtensions.byName(this.getRace().getStats(),stat.getName()).getModifiers().getItem(1)))),Xethya.Entities.StatExtensions.byName(this.getStats(),stat.getName()).getModifiers().add(raceTrait2)}});Bridge.ns("Xethya.Entities.LivingEntity",$_);Bridge.apply($_.Xethya.Entities.LivingEntity,{f1:function(a){return a.getValue().gte(Bridge.Decimal(27))}});Bridge.init()})(this);